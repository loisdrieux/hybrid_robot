<?xml version="1.0"?>
<robot name="hybrid_robot" xmlns:xacro="http://www.ros.org/wiki/xacro">

    <xacro:include filename="hybrid_terrestrial.xacro" />
    <xacro:include filename="hybrid_aerial.xacro" />

    <link name="base_footprint"/>

    <joint name="base_footprint_joint" type="fixed">
        <parent link="base_footprint"/>
        <child link="world_anchor"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
    </joint>

    <link name="world_anchor">
        <inertial>
            <mass value="10.0"/>
            <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
        </inertial>
    </link>

    
    

    <joint name="lift_joint" type="prismatic">
        <parent link="world_anchor" />
        <child link="base_link" />
        <origin xyz="0 0 0.05" rpy="0 0 0" />
        <axis xyz="0 0 1" />
        <limit lower="0.0" upper="5.0" effort="2000.0" velocity="2.0" />
        <dynamics damping="1.0" friction="0.0" />
    </joint>

    <xacro:drone_assembly />
    <joint name="drone_fixed_mount" type="fixed">
        <parent link="landing_pad" />
        <child link="drone_base_link" />
        <origin xyz="0 0 0.01" rpy="0 0 0" />
    </joint>

    <gazebo reference="lift_joint">
        <implicitSpringDamper>true</implicitSpringDamper>
    </gazebo>
    <gazebo reference="left_wheel_joint">
        <implicitSpringDamper>true</implicitSpringDamper>
    </gazebo>
    <gazebo reference="right_wheel_joint">
        <implicitSpringDamper>true</implicitSpringDamper>
    </gazebo>

    <ros2_control name="HybridControl" type="system">
        <hardware>
            <plugin>gazebo_ros2_control/GazeboSystem</plugin>
        </hardware>
        <joint name="left_wheel_joint">
            <command_interface name="velocity"/>
            <state_interface name="velocity"/>
            <state_interface name="position"/>
        </joint>
        <joint name="right_wheel_joint">
            <command_interface name="velocity"/>
            <state_interface name="velocity"/>
            <state_interface name="position"/>
        </joint>
        <joint name="lift_joint">
            <command_interface name="position"/>
            <state_interface name="position"/>
            <state_interface name="velocity"/>
        </joint>
    </ros2_control>

    <gazebo reference="world_anchor">
        <gravity>false</gravity>
    </gazebo>

    <gazebo>
        <plugin name="drone_flight_controller" filename="libgazebo_ros_planar_move.so">
            <ros>
                <namespace>/</namespace>
                <parameter name="use_sim_time" value="true" />
                <remapping>cmd_vel:=cmd_drone</remapping>
                <remapping>odom:=odom_drone</remapping>
            </ros>
            <update_rate>100</update_rate>
            <publish_rate>50</publish_rate>
            <publish_odom>true</publish_odom>
            <publish_odom_tf>true</publish_odom_tf>
            
            <robotBaseFrame>world_anchor</robotBaseFrame>
            <odometryFrame>odom</odometryFrame>
        </plugin>
    </gazebo>

    <gazebo>
        <plugin filename="libgazebo_ros2_control.so" name="gazebo_ros2_control">
            <parameters>$(find hybrid_robot_description)/config/terrestrial_control.yaml</parameters>
        </plugin>
    </gazebo>
</robot>
